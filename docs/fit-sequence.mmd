sequenceDiagram
    autonumber
    actor Client
    participant MW as Latency Middleware
    participant Route as FastAPI /fit/{series_id}
    participant Service as TrainService
    participant Trainer as AnomalyDetectionTrainer
    participant Model as SimpleModel
    participant Record as AnomalyDetectionRecord
    participant Version as SeriesVersionRecord
    participant DB as PostgreSQL
    participant Cache as LatencyRecord
    participant Redis as Redis
    participant Store as LocalStorage
    participant FS as Local Filesystem

    Client->>MW: POST /fit/{series_id}
    MW->>Route: call_next(request)
    Route->>Route: Validate SeriesId + TrainData
    Route->>Service: train(series_id, payload)
    Service->>Service: _to_time_series + validate_for_training()

    Service->>Trainer: train(time_series)
    Trainer->>Model: fit(data, callback)
    Trainer->>Model: save()
    Model-->>Trainer: ModelState
    Trainer-->>Service: ModelState

    Service->>Record: build(series_id, version=None, paths=None)
    Service->>Record: save(session, record)
    Record->>Version: next_version(session, series_id)
    Version->>DB: INSERT .. ON CONFLICT .. RETURNING
    DB-->>Version: assigned version
    Version-->>Record: version
    Record->>DB: INSERT + FLUSH
    DB-->>Record: metadata persisted

    Service->>Store: save_state(series_id, version, state)
    Store->>FS: write model JSON
    FS-->>Store: model_path

    Service->>Store: save_data(series_id, version, time_series)
    Store->>FS: write training data JSON
    FS-->>Store: data_path

    Service->>Record: update(model_path, data_path)
    Service->>Record: commit()
    Record->>DB: COMMIT

    Service-->>Route: TrainResponse
    Route-->>MW: 200 response
    MW->>Cache: push_latency(train, elapsed_ms)
    Cache->>Redis: RPUSH + LTRIM
    MW-->>Client: 200 response
