sequenceDiagram
    autonumber
    actor Client
    participant API as FastAPI /fit/{series_id}
    participant ASchema as TrainData Validator
    participant CoreSchema as TimeSeries/DataPoint
    participant Service as TrainService
    participant Trainer as AnomalyDetectionTrainer
    participant Model as SimpleModel
    participant Store as LocalStorage
    participant ORM as AnomalyDetectionRecord
    participant Version as SeriesVersionRecord
    participant DB as PostgreSQL
    participant FS as Local Filesystem

    Client->>API: POST /fit/{series_id}\n{timestamps, values}
    API->>ASchema: Validate payload
    ASchema-->>API: TrainData
    API->>CoreSchema: Build TimeSeries(DataPoint[])
    CoreSchema-->>API: TimeSeries
    API->>Service: train(series_id, payload)

    Service->>Trainer: train(time_series)
    Trainer->>Model: fit(data)
    Model-->>Trainer: ModelState(mean, std)
    Trainer-->>Service: ModelState

    Service->>ORM: save(session, record)
    ORM->>Version: next_version(session, series_id)
    Version->>DB: INSERT ... ON CONFLICT ... RETURNING
    DB-->>Version: next_version
    Version-->>ORM: next_version
    ORM->>DB: INSERT + FLUSH
    ORM-->>Service: version

    Service->>Store: save_state(series_id, version, state)
    Store->>FS: Write .json model artifact
    FS-->>Store: model_path
    Store-->>Service: model_path

    Service->>Store: save_data(series_id, version, payload)
    Store->>FS: Write .json training data
    FS-->>Store: data_path
    Store-->>Service: data_path

    Service->>ORM: update(model_path, data_path)
    Service->>ORM: commit()
    ORM->>DB: COMMIT
    DB-->>ORM: committed

    Service-->>API: TrainResponse
    API-->>Client: 200 TrainResponse
